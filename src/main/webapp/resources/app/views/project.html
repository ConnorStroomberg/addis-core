<div ui-view>
  <navbar-directive></navbar-directive>
  <ul ng-show="loading.loaded" class="breadcrumbs fixed">
    <li><a ui-sref="datasets({userUid: user.id})">{{::user.firstName}} {{::user.lastName}}</a></li>
    <li><a ui-sref="projects({userUid: userId})">Projects</a></li>
    <li class="current active">{{::project.name}}</li>
  </ul>

  <div class="project-header row">
    <div class="columns large-6 medium-6">
      <div>
        <h1 class="inline-header" title="Project title">{{project.name}}
          <a ng-if="editMode.allowEditing" title="Edit title and description" ng-click="openEditProjectDialog()"><i class="fa fa-edit"></i></a>
        </h1>
      </div>
      <div>
        <span ng-if=project.archived><i class="fa fa-exclamation-triangle"></i> archived on {{project.archivedOn}}</span>
      </div>
      <div>
        <h5>Source dataset:
          <a ui-sref="versionedDataset({userUid: trialverse.ownerId, datasetUuid: project.namespaceUid, versionUuid: project.datasetVersion.split('/versions/')[1]})">{{::trialverse.name}}</a>
          <span tooltip-html-unsafe="Current base: <em>{{currentRevision.versionDate | date:'medium'}}</em>
        <div>
          {{currentRevision.versionTitle}}
        </div>
        <div>
          Created by {{!currentRevision.applicationName ? '' : currentRevision.applicationName + ' on behalf of '}} {{currentRevision.creator}}
        </div>" ng-if="loading.loaded && trialverse.headVersion !== trialverse.version">(<i class="fa fa-exclamation-triangle"></i> A newer version of this dataset
            exists)
          </span>
          <span ng-if="loading.loaded && trialverse.headVersion === trialverse.version" tooltip-html-unsafe="Current base: <em>{{currentRevision.versionDate | date:'medium'}}</em>
        <div>
          {{currentRevision.versionTitle}}
        </div>
        <div>
          Created by {{!currentRevision.applicationName ? '' : currentRevision.applicationName + ' on behalf of '}} {{currentRevision.creator}}
        </div>">(<i class="fa fa-check"></i> Based on the latest dataset version)</span>
        </h5>
        <button ng-if="editMode.allowEditing && trialverse.headVersion !== trialverse.version"
          ng-click="openUpdateDialog()" class="small success radius">Update</button>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="columns large-12">
      <tabset>
        <tab heading="Report" active="tabSelection.activeTab === 'report'" ng-click="setActiveTab('report')">
          <div ng-if="tabSelection.activeTab === 'report'">
            <div class="row">
              <div ng-show="!showLegacyReport" class="columns large-9">
                <markdown-report></markdown-report>
              </div>
              <div ng-show="showLegacyReport" class="columns large-9">
                <!-- outcomes -->
                <div class="row">
                  <div class="columns large-12">
                    <h3 class="subheader">Outcomes
                      <inline-help help-key="addis-outcome"></inline-help>
                    </h3>
                    <ul>
                      <li ng-show="outcomes.length === 0 ">no outcomes defined</li>
                      <li ng-repeat="outcome in outcomes | orderBy:'name'">
                        <strong>{{outcome.name}}
                          <span ng-if="outcome.motivation.length">:</span>
                        </strong>{{outcome.motivation}}
                      </li>
                    </ul>
                  </div>
                </div>
                <!-- interventions -->
                <div class="row">
                  <div class="columns large-12">
                    <h3 class="subheader">Interventions
                      <inline-help help-key="addis-intervention"></inline-help>
                    </h3>
                    <ul>
                      <li ng-show="interventions.length === 0 ">no interventions defined</li>
                      <li ng-repeat="intervention in interventions | orderBy:'name'">
                        <strong>{{intervention.name}}
                          <span ng-if="intervention.motivation.length">:</span>
                        </strong>{{intervention.motivation}}
                      </li>
                    </ul>
                  </div>
                </div>
                <!-- covariates -->
                <div class="row">
                  <div class="columns large-12">
                    <h3 class="subheader">Covariates
                      <inline-help help-key="covariate"></inline-help>
                    </h3>
                    <ul>
                      <li ng-show="covariates.length === 0 ">no covariates defined</li>
                      <li ng-repeat="covariate in covariates | orderBy:'name'">
                        <strong>{{covariate.name}}
                          <span ng-if="covariate.motivation">:</span>
                        </strong>{{covariate.motivation}}
                      </li>
                    </ul>
                  </div>
                </div>
                <!-- analyses -->
                <div class="row" ng-repeat="analysis in analyses">
                  <div class="columns large-12">
                    <h2>Analysis: {{::analysis.title}}
                      <inline-help help-key="addis-analysis"></inline-help>
                    </h2>
                    <p ng-show="!analysis.description">
                      <em>no description</em>
                    </p>
                    <p>{{::analysis.description}}</p>
                    <div ng-if="analysis.analysisType === 'Evidence synthesis'">
                      <nma-report-view user="user" project="project" analysis="analysis" interventions="interventions"></nma-report-view>
                    </div>
                    <div ng-if="analysis.analysisType === 'Benefit-risk analysis based on a single study' || analysis.analysisType === 'Benefit-risk analysis based on meta-analyses'">
                      <ssbr-report-view user="user" project="project" analysis="analysis" interventions="interventions"></ssbr-report-view>
                    </div>
                  </div>
                </div>
              </div>
              <div class="columns large-3">
                <button class="right" ng-if="editMode.allowEditing" ng-click="goToEditView()">Customize</button>
              </div>
            </div>
          </div>
        </tab>

        <tab heading="Details" active="tabSelection.activeTab === 'details'" ng-click="setActiveTab('details')">
          <div ng-if="tabSelection.activeTab === 'details'">
            <!-- Analyses -->
            <div class="row section">
              <div class="columns large-6 ">
                <h2>Analyses
                  <inline-help help-key="addis-analysis"></inline-help>
                </h2>
                <button id="show-create-analysis-modal-btn" ng-if="editMode.allowEditing" ng-disabled="!loading.loaded"
                  class="small" ng-click="openAddAnalysisDialog()"><i class="fa fa-plus"></i> Add Analysis
                </button>

                <div ng-show="!analysesLoaded">
                  <i class="fa fa-spinner fa-spin fa-3x"></i>
                  <p>Loading analyses...</p>
                </div>
                <div>
                  <em ng-show="analysesLoaded && analyses.length === 0">No analyses have been defined</em>
                </div>
                <div ng-show="analysesLoaded && analyses.length > 0">
                  <table style="width: 100%;">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Analysis type</th>
                        <th>Data source</th>
                        <th>
                          <button ng-disabled="numberOfAnalysesArchived === 0" ng-hide="showArchived || !analysesLoaded"
                            class="button secondary small right ng-binding no-margin"
                            ng-click="toggleShowArchived()" style=""><i class="fa fa-eye"></i> Show archived ({{numberOfAnalysesArchived}})
                          </button>
                          <button ng-hide="!showArchived || !analysesLoaded" class="button secondary small right ng-binding no-margin"
                            ng-click="toggleShowArchived()" style=""><i class="fa fa-eye"></i> Hide archived ({{numberOfAnalysesArchived}})
                          </button>

                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr ng-repeat="analysis in analyses" ng-switch="analysis.analysisType">
                        <div>
                          <td ng-show="showArchived || analysis.archived === false" class="clickable on-hover"
                            ng-click="goToAnalysis(analysis)">
                            <a>{{analysis.title}}</a>
                            <span ng-if="analysis.archived"> (archived on: {{analysis.archivedOn}})</span>
                          </td>
                          <td ng-show="showArchived || analysis.archived === false">{{analysis.analysisType}}</td>
                          <td ng-show="showArchived || analysis.archived === false" ng-switch-when="Benefit-risk analysis based on a single study">{{findStudyLabel(analysis)}}
                          </td>
                          <td ng-show="showArchived || analysis.archived === false" ng-switch-when="Evidence synthesis"></td>
                          <td ng-show="showArchived || analysis.archived === false" ng-switch-when="Benefit-risk analysis based on meta-analyses"></td>
                          <td ng-show="showArchived || analysis.archived === false">
                            <button ng-if="!analysis.archived && editMode.allowEditing" ng-click="archiveAnalysis(analysis)"
                              type="button" class="tiny right info radius" style="margin-bottom:0;">archive</button>
                            <button ng-if="analysis.archived && editMode.allowEditing" ng-click="unarchiveAnalysis(analysis)"
                              type="button" class="tiny right alert radius" style="margin-bottom:0;">unarchive</button>
                          </td>
                        </div>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="row section">
              <!-- Outcomes -->
              <div class="columns large-12">
                <h3 class="subheader">Outcomes
                  <inline-help help-key="addis-outcome"></inline-help>
                </h3>
                <button id="show-create-outcome-modal-btn" ng-if="editMode.allowEditing" ng-disabled="!loading.loaded"
                  class="small" ng-click="openCreateOutcomeDialog()"><i class="fa fa-plus"></i> Add outcome
                </button>
                <table style="width: 100%;">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Outcome direction</th>
                      <th>Motivation</th>
                      <th>Definition</th>
                      <th ng-if="editMode.allowEditing"></th>
                      <th ng-if="editMode.allowEditing"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr ng-repeat="outcome in outcomes">
                      <td>{{outcome.name}}</td>
                      <td style="text-align: center;" ng-if="outcome.direction == 1">Higher is better</td>
                      <td style="text-align: center;" ng-if="outcome.direction == -1">Lower is better</td>
                      <td>{{outcome.motivation}}</td>
                      <td>{{::outcome.semanticOutcomeLabel}}</td>
                      <td style="text-align: center;" ng-if="editMode.allowEditing"><a ng-click="openEditOutcomeDialog(outcome)"><i class="fa fa-edit fa-2x"></i></a></td>
                      <td style="text-align: center;" ng-if="editMode.allowEditing && !outcomeUsage[outcome.id].length">
                        <a ng-click="openDeleteDefinitionDialog(outcome,'outcome')"><i class="fa fa-trash  fa-2x" style="color:red"></i></a>
                      </td>
                      <td style="text-align: center;" ng-if="editMode.allowEditing && outcomeUsage[outcome.id].length">
                        <a class="has-tip" tooltip-html-unsafe="<i class='fa fa-exclamation-triangle'></i> Outcome is used in analyses: {{outcomeUsage[outcome.id].join(', ')}}"
                          tooltip-placement="left">
                          <i class="fa fa-trash fa-2x" style="color: lightgrey;"></i>
                          </span>
                        </a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="row section">
              <!-- Interventions -->
              <div class="columns large-12">
                <h3 class="subheader">Interventions
                  <inline-help help-key="addis-intervention"></inline-help>
                </h3>
                <button id="show-create-intervention-modal-btn" ng-if="editMode.allowEditing" ng-disabled="!loading.loaded"
                  class="small " ng-click="openCreateInterventionDialog()"><i class="fa fa-plus"></i> Add intervention
                </button>
                <table>
                  <thead>
                    <tr>
                      <th class="large-2">Name</th>
                      <th class="large-5">Motivation</th>
                      <th class="large-5">Definition</th>
                      <th ng-if="editMode.allowEditing"></th>
                      <th ng-if="editMode.allowEditing"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr ng-repeat="intervention in interventions">
                      <td>{{intervention.name}}</td>
                      <td>{{intervention.motivation}}</td>
                      <td>{{::intervention.semanticInterventionLabel}}{{::intervention.definitionLabel}}</td>
                      <td style="text-align: center;" ng-if="editMode.allowEditing"><a ng-click="openEditInterventionDialog(intervention)"><i class="fa fa-edit fa-2x"></i></a></td>
                      <td class="text-center" ng-if="editMode.allowEditing && !interventionUsage.inAnalyses[intervention.id].length && !interventionUsage.inInterventions[intervention.id].length">
                        <a ng-click="openDeleteDefinitionDialog(intervention,'intervention')"><i class="fa fa-trash  fa-2x" style="color:red"></i></a>
                      </td>
                      <td ng-if="editMode.allowEditing && (interventionUsage.inInterventions[intervention.id].length || interventionUsage.inAnalyses[intervention.id].length)">
                        <a class="has-tip" tooltip-html-unsafe="{{!interventionUsage.inAnalyses[intervention.id].length ? '' : '<i class=\'fa fa-exclamation-triangle\'></i> Intervention is used in analyses: ' + interventionUsage.inAnalyses[intervention.id].join(', ') + '<br>'}}

                          {{!interventionUsage.inInterventions[intervention.id].length? '' : '<i class=\'fa fa-exclamation-triangle\'></i> Intervention is used in interventions: ' + interventionUsage.inInterventions[intervention.id].join(', ') }}"
                          tooltip-placement="left">
                          <i class="fa fa-trash fa-2x" style="color: lightgrey;"></i>
                          </span>
                        </a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Covariates -->
            <div class="row section">
              <div class="columns large-12">

                <h3 class="subheader">Covariates
                  <inline-help help-key="addis-covariate"></inline-help>
                </h3>
                <button ng-if="editMode.allowEditing" ng-disabled="!loading.loaded" class="small"
                  ng-click="addCovariate()"><i class="fa fa-plus"></i> Add Covariate
                </button>

                <div ng-show="!covariatesLoaded">
                  <i class="fa fa-spinner fa-spin fa-3x"></i>

                  <p>Loading covariates... </p>
                </div>

                <em ng-show="covariatesLoaded && covariates.length === 0">No covariates have been defined</em>
                <table ng-show="covariatesLoaded && covariates.length > 0">
                  <thead>
                    <tr>
                      <th class="large-3">Name</th>
                      <th class="large-6 end">Motivation</th>
                      <th class="large-3">Definition</th>
                      <th ng-if="editMode.allowEditing"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr ng-repeat="covariate in covariates">
                      <td>{{::covariate.name}}</td>
                      <td>{{::covariate.motivation}}</td>
                      <td>{{::covariate.definitionLabel}}</td>
                      <td class="text-center" ng-if="editMode.allowEditing && !covariateUsage[covariate.id].length">
                        <a ng-click="openDeleteDefinitionDialog(covariate,'covariate')"><i class="fa fa-trash  fa-2x" style="color:red"></i></a>
                      </td>
                      <td ng-if="editMode.allowEditing && covariateUsage[covariate.id].length">
                        <a class="has-tip" tooltip-html-unsafe="<i class='fa fa-exclamation-triangle'></i> Covariate is used in analyses: {{covariateUsage[covariate.id].join(', ')}}"
                          tooltip-placement="left">
                          <i class="fa fa-trash fa-2x" style="color: lightgrey;"></i>
                          </span>
                        </a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </tab>
      </tabset>
    </div>
  </div>
</div>
