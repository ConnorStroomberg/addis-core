---
layout: default
title: Versioning mechanism
---

Defines a mechanism for versioning of RDF datasets, which are collections of graphs.
This serves as a back-end to the datasets offered through the Trialverse API.
It is less specific and constrained in a number of ways.
Specifically, it is not concerned with authentication or authorization and will execute any request given to it, as long as it is a valid request.

Data model
----------

The data model is described in RDF, using a vocabulary under the prefix `http://drugis.org/eventSourcing/es#`, abbreviated as `es:`.
Use is also made of Dublin Core, abbreviated as `dc:`.
All datasets served by the event sourcing RDF store are stored in a single underlying RDF dataset.
The meta-data are stored in the default graph, and named graphs are used to store differences between graph versions.

Datasets match the following pattern:

```turtle
?dataset a es:Dataset ;
  dc:date ?creationDate ;
  dc:creator ?creatorUri ;
  es:head ?version .
```

Of these triples, only the `?dataset es:head ?version` triple will ever change.
The `?creatorUri` has no specific meaning to the event sourcing system, but is assumed to be meaningful to the client.
The `?version` is further defined as:

```turtle
?version a es:DatasetVersion ;
  dc:date ?versionDate ;
  dc:creator ?creatorUri .
```

Most versions will also point to their predecessor using

```turtle
?version es:previous ?previousVersion .
```

Each version enumerates the graphs it contains, by pointing to specific graph revisions:

```turtle
?version es:graph_revision [
    es:graph ?graphUri ;
    es:revision ?revision .
  ] .
```

```turtle
?version es:default_graph_revision [
    es:revision ?revision .
  ] .
```

A revision is a changeset applie to a single graph, and is represented as follows:

```turtle
?revision a es:Revision ;
  es:version ?version ;
  es:previous ?previousRevision ;
  es:assertions ?assertionsGraph ;
  es:retractions ?retractionsGraph .
```

A version refers to a revision of each graph it contains, but a revision also refers to a specific version.
This allows the same revision of a graph to be referred to in different versions of a dataset, or in different datasets, while still uniquely identifying the event in which the revision was created.
For example, this enables a use case like the following:

```
 --o---o---o---o---o---o---o---o---------   dataset A
            \                   \
             o-------------------o---o---   dataset B
```

Here, dataset B adopts a specific revision of the graph of interest from dataset A.
After some time, the maintainer of dataset B decides to update his revision of the graph to the latest version, and he subsequently makes changes of his own.
Here, all but the last revision of the graph are credited to versions of dataset A, while the last revision is credited to a version of dataset B.
Because the first and second versions of dataset B refer to revisions of the graph that do not belong to dataset B, these changes can be displayed differently, e.g. as "Graph G taken from version X of dataset A".
This could enable two views of the history of an individual graph: the history within the specific dataset, and the linear history as recorded by the series of revisions.
Also note that no meta-data is recorded on revisions, as these are stored on the associated version.

The contents of a dataset version can be constructed by constructing the contents of each revision.
These, in turn, can be constructed by replaying the series of changesets given by the `es:previous` property on each revision, from oldest to newest.

URIs for datasets, versions, revisions, assertions, and retractions are generated by the event sourcing store, and are expected to resolve properly, as described below.

TODO: should each version also refer back to the dataset?

Algorithm for changesets
------------------------

TODO: how changesets are computed, and how they are applied to a previous state. Handling of blank nodes.

Creating datasets
-----------------

A new dataset is created though a POST request to /datasets.
The X-EventSource-Author header can be used to specify a URI identifying the author.

```
POST /datasets HTTP/1.1
Host: example.com
X-EventSource-Author: http://example.com/GreenGoblin
```

This will result in a `201 Created response` indicating both the location of the new dataset and the initial version ID.

```
HTTP/1.1 201 Created
Location: http://example.com/datasets/ubb245f8sz
X-EventSource-Version: http://example.com/versions/3ucq3j5c7u
```

Updating and querying datasets
------------------------------

Under `/datasets/:dataset-id` reside a SPARQL protocol query (`./query`) and update (`./update`) endpoint, as well as a SPARQL graph store (`./data`) using the indirect graph identification pattern.
The protocol is modified in three ways:

 1. All requests can specify the `X-Accept-EventSource-Version` header, and the server will `Vary: X-Accept-EventSource-Version`.
For requests that do not alter the state (i.e. requests to the query endpoint and `GET` requests to the graph store), the header indicates that the contents of a previous version are being queried.
For requests that do alter state, the header indicates that the requests expects the latest version to be the version specified in the header.
If it is not, the request fails with a `409 Conflict` response.
If the header is not specified, the action is executed against the latest version.

 2. All write requests can specify the `X-EventSource-Author` header to set the author attribute of the new version.

 3. All requests return a `X-EventSource-Version` header. For read requests this indicates the version being returned, while for write requests it indicates the new version created.

TODO: should the request headers be mandatory?

Investigating history
---------------------

```
GET /datasets/:dataset-id HTTP/1.1
Host: example.com
```

Should return the full history for the given dataset, including the dataset definition itself.
In particular, this can be resolved using the following SPARQL query (where `:dataset` needs to be replaced):

```sparql
PREFIX owl: <http://www.w3.org/2002/07/owl#>
PREFIX es: <http://drugis.org/eventSourcing/es#>
PREFIX dataset: <http://example.com/datasets/>

SELECT ?s ?p ?o
WHERE {
  :dataset owl:sameAs{0} ?dataset .

  ?dataset es:head ?head .
  ?head es:previous* ?version .
  {
    ?version es:graph_revision ?graphRev .
  } UNION {
    ?version es:default_graph_revision ?graphRev .
  }
  ?graphRev es:revision/es:previous* ?revision .
  ?revision es:version ?referencedVersion .

  {
    ?dataset owl:sameAs{0} ?s .
  } UNION {
    ?version owl:sameAs{0} ?s .
  } UNION {
    ?graphRev owl:sameAs{0} ?s .
  } UNION {
    ?revision owl:sameAs{0} ?s .
  } UNION {
    ?referencedVersion owl:sameAs{0} ?s .
  }

  ?s ?p ?o .
}
```

Each version will return a description of itself, including any revisions and the dataset (TODO: see above for whether this is possible).

Each revision will return its contents. TODO: is there any way of finding out which versions or datasets a revision belongs to? This could be a useful "so many times cited" metric.

Each assertions and retractions will return its contents.


Merging
-------

Merges will not be supported directly by the event sourcing store, but can be indicated in meta-data for specific commits.
How these meta-data are defined is to be determined.
Essentially, they will add secondary parent states to a version or revision, for example using an `es:merged` predicate.

Example
-------

Say the Green Goblin creates a dataset to state that, in fact, Peter Parker goes by the names "Peter Parker" and "Spiderman".

To do this, we first create the new dataset:

```
POST /datasets HTTP/1.1
Host: example.com
X-EventSource-Author: http://example.com/GreenGoblin
```

And the server responds with a newly created dataset, and indicates the initial version ID:

```
HTTP/1.1 201 Created
Location: http://example.com/datasets/ubb245f8sz
X-EventSource-Version: http://example.com/versions/3ucq3j5c7u
```

After this, the triple store looks like:

```turtle
@prefix dc:   <http://purl.org/dc/elements/1.1/> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .

@prefix es: <http://drugis.org/eventSourcing/es#> .
@prefix dataset: <http://example.com/datasets/> .

es:log {

  dataset:ubb245f8sz a es:Dataset ;
    dc:date "2014-09-24T12:40:03+0000"^^xsd:dateTime ;
    dc:creator <http://example.com/GreenGoblin> ;
    es:head version:3ucq3j5c7u .

  version:3ucq3j5c7u a es:DatasetVersion ;
    dc:date "2014-09-24T12:40:03+0000"^^xsd:dateTime ;
    dc:creator <http://example.com/GreenGoblin> .

}
```

Then, we post new contents for the graph describing Peter Parker:

```
POST /datasets/ubb245f8sz/data?graph=http://example.com/PeterParker HTTP/1.1
Host: example.com
Content-Type: text/turtle
X-EventSource-Author: http://example.com/GreenGoblin
X-EventSource-Previous: http://example.com/versions/3ucq3j5c7u

@prefix foaf: <http://xmlns.com/foaf/0.1/> .

<http://example.com/PeterParker> a foaf:Person ;
  foaf:name "Peter Parker", "Spiderman" .
```

The response has no content, and contains a header indicating the created version:

```
HTTP/1.1 204 No Content
X-EventSource-Version: http://example.com/versions/7wi4xglx1c
```

Now, Peter Parker wants to dispute this claim made by the Green Goblin, and starts by creating a copy of his dataset:

```
POST /datasets?copyOf=http://example.com/versions/7wi4xglx1c HTTP/1.1
X-EventSource-Author: http://example.com/PeterParker
```

The response, again, indicates the location and version of the newly created dataset:

```
HTTP/1.1 201 Created
Location: http://example.com/datasets/qmk2x16nz1
X-EventSource-Version: http://example.com/versions/7wi4xglx1c
```

Then Peter procedes to run a SPARQL update query to set the record straight:

```
POST /datasets/qmk2x16nz1/update HTTP/1.1
Content-Type: application/sparql-query
X-EventSource-Author: http://example.com/PeterParker
X-EventSource-Previous: http://example.com/versions/7wi4xglx1c

PREFIX foaf: <http://xmlns.com/foaf/0.1/>

DELETE DATA {
  GRAPH <http://example.com/PeterParker> {
    <http://example.com/PeterParker> foaf:name "Spiderman"
  }
};
INSERT DATA {
  GRAPH <http://example.com/Spiderman> {
    <http://example.com/Spiderman> a foaf:Person ;
      foaf:name "Spiderman" .
  }
  GRAPH <http://example.com/PeterParker> {
    <http://example.com/PeterParker> foaf:homepage <http://www.okcupid.com/profile/PeterParker> .
  }
}
```

Which results in a newly created version:

```
HTTP/1.1 204 No Content
X-EventSource-Version: http://example.com/versions/g05ri5qvvq
```


### Complete turtle of final store

```turtle
@prefix dc:   <http://purl.org/dc/elements/1.1/> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .

@prefix es: <http://drugis.org/eventSourcing/es#> .

@prefix dataset: <http://example.com/datasets/> .
@prefix version: <http://example.com/versions/> .
@prefix revision: <http://example.com/revisions/> .
@prefix assert: <http://example.com/assertions/> .
@prefix retract: <http://example.com/retractions/> .

dataset:qmk2x16nz1 a es:Dataset ;
  dc:date "2014-09-24T12:49:18+0000"^^xsd:dateTime ;
  dc:creator <http://example.com/Spiderman> ;
  es:head version:g05ri5qvvq .

dataset:ubb245f8sz a es:Dataset ;
  dc:date "2014-09-24T12:40:03+0000"^^xsd:dateTime ;
  dc:creator <http://example.com/GreenGoblin> ;
  es:head version:7wi4xglx1c .

version:g05ri5qvvq a es:DatasetVersion ;
  dc:date "2014-09-24T12:58:16,835290832+0000"^^xsd:dateTime ;
  dc:creator <http://example.com/Spiderman> ;
  es:previous version:7wi4xglx1c ;
  es:graph_revision [
    es:graph <http://example.com/Spiderman> ;
    es:revision revision:302431f4-43e8-11e4-8745-c72e64fa66b1
  ] ;
  es:graph_revision [
    es:graph <http://example.com/PeterParker> ;
    es:revision revision:44ea0618-43e8-11e4-bcfb-bba47531d497
  ] .

version:7wi4xglx1c a es:DatasetVersion ;
  dc:date "2014-09-24T12:45:25,048366032+0000"^^xsd:dateTime ;
  dc:creator <http://example.com/GreenGoblin> ;
  es:previous version:3ucq3j5c7u ;
  es:graph_revision [
    es:graph <http://example.com/PeterParker> ;
    es:revision revision:38fc1de7a-43ea-11e4-a12c-3314171ce0bb
  ] .

version:3ucq3j5c7u a es:DatasetVersion ;
  dc:date "2014-09-24T12:40:03+0000"^^xsd:dateTime ;
  dc:creator <http://example.com/GreenGoblin> .

revision:302431f4-43e8-11e4-8745-c72e64fa66b1 a es:Revision ;
  es:version version:g05ri5qvvq ;
  es:assertions assert:302431f4-43e8-11e4-8745-c72e64fa66b1 .

revision:44ea0618-43e8-11e4-bcfb-bba47531d497 a es:Revision ;
  es:version version:g05ri5qvvq ;
  es:previous revision:38fc1de7a-43ea-11e4-a12c-3314171ce0bb ;
  es:assertions assert:44ea0618-43e8-11e4-bcfb-bba47531d497 ;
  es:retractions retract:44ea0618-43e8-11e4-bcfb-bba47531d497 .

revision:38fc1de7a-43ea-11e4-a12c-3314171ce0bb a es:Revision ;
  es:version version:7wi4xglx1c ;
  es:assertions assert:844908ec-43eb-11e4-ac51-6b523949084e .

assert:844908ec-43eb-11e4-ac51-6b523949084e {

  <http://example.com/PeterParker> a foaf:Person ;
    foaf:name "Peter Parker", "Spiderman" .

}

retract:44ea0618-43e8-11e4-bcfb-bba47531d497 {

  <http://example.com/PeterParker> foaf:name "Spiderman" .

}

assert:44ea0618-43e8-11e4-bcfb-bba47531d497 {

  <http://example.com/PeterParker> foaf:homepage <http://www.okcupid.com/profile/PeterParker> .

}

assert:302431f4-43e8-11e4-8745-c72e64fa66b1 {

  <http://example.com/Spiderman> a foaf:Person;
    foaf:name "Spiderman" .

}
```
